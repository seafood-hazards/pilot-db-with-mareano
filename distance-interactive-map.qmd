---
title: "Interactive Map of Core Locations"
subtitle: Interactive map to view sediment core locations 
---

::: {.callout-note}
## Note on Distance Accuracy

Calculated distances represent the shortest Euclidean path to the nearest coastline geometry (GSHHG dataset). 

While the data is projected (EPSG:3035) to minimize distortion at high latitudes, please interpret these values as **estimates**. In areas with complex topography—such as narrow fjords or dense archipelagos—the resolution of the coastline vector data may result in minor deviations from real-world measurements.
:::

## Interactive Map

The map below displays the spatial distribution of sediment cores. The markers are color-coded based on their distance from the nearest Norwegian coastline.

**How to use this map:**

*   **Filter** the data by toggling distance categories in the top-right menu (e.g., uncheck boxes to hide specific ranges).
*   **Zoom and Pan** to explore specific coastal areas or offshore regions.
*   **Hover** over a point to quickly identify the **Cruise ID** and **Core ID**.
*   **Click** on a marker to view detailed metadata, including exact coordinates and distance to shore (in km).
*   Use the **Legend** in the bottom right to interpret the color coding.

```{r}
#| column: page       
#| fig-height: 7

library(leaflet)
library(viridis)
library(dplyr)
library(sf)

# 1. Load Data
points_web <- readRDS(".data/points_web.Rds")

# 2. Palette
pal <- colorFactor(palette = "turbo", domain = points_web$Distance)

# 3. Initialize the Map
# We start with just the base tiles and the view
map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  # Focus on Norway (excluding Russia/Greenland)
  setView(lng = 15, lat = 68, zoom = 4) 

# 4. Loop to Add Points by Group
# Get the list of unique categories (e.g., "0 to 10km", "≥100km")
dist_groups <- levels(points_web$Distance)

for(group_name in dist_groups) {
  
  # Filter data for this specific group
  data_subset <- points_web[points_web$Distance == group_name, ]
  
  # Add markers for this group ONLY
  map <- map %>%
    addCircleMarkers(
      data = data_subset,
      group = group_name,  # <--- THIS IS KEY: Assigns points to a toggleable group
      radius = 6,
      color = pal(group_name),     # Use the specific color for this group
      fillColor = pal(group_name),
      fillOpacity = 0.7,
      weight = 1,
      
      # Popup/Label logic
      label = ~paste0("Cruise: ", cruise_id, ", Core: ", core_id),
      popup = ~paste0(
        "<strong>Cruise ID:</strong> ", cruise_id, "<br>",
        "<strong>Core ID:</strong> ", core_id, "<br>",
        "<strong>Latitude:</strong> ", round(ddn, 2), "<br>",
        "<strong>Longitude:</strong> ", round(dde, 2), "<br>",
        "<strong>Distance:</strong> ", round(dist_to_coast, 1), " km"
      )
    )
}

# 5. Add the Control Box (Checkboxes) & Legend
map %>%
  addLayersControl(
    overlayGroups = dist_groups, # Creates checkboxes for our groups
    options = layersControlOptions(collapsed = FALSE) # Keep menu open
  ) %>%
  addLegend(
    position = "bottomright",
    pal = pal,
    values = points_web$Distance, # Use full data for legend so all colors show
    title = "Distance to Coast",
    opacity = 1
  )


```
